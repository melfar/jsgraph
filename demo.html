<script type="text/javascript" src="js/wz_jsgraphics.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>

<style>
body {
  z-index: 2;
}

.node {
  position: absolute;
  display:  none;
}

#debug {
  position: absolute;
  right: 10px;
  top: 10px;
  width: 400px;
  height: 90%;
  xborder: 1px solid #ccc;
  padding: 4px;
  font: 10px helvetica;
}

#graph {
  position: relative;
  width: 250px;
  height:250px;
  margin-left: 10px;
  margin-top: 10px;
}
</style>

<body>
  <div id="graph">
    <div id="node1" class="node">
      <div id="node2" class="node"></div>
      <div id="node3" class="node">
        <div id="node4" class="node">
          <div id="node5" class="node"></div>
          <div id="node6" class="node"></div>
        </div>
      </div>

      <div id="node7" class="node">
        <div id="node8" class="node"></div>
        <div id="node9" class="node">
          <!-- <div id="node10" class="node"></div>
          <div id="node11" class="node">
            <div id="node12" class="node">
              <div id="node13" class="node"></div>
              <div id="node14" class="node"></div>
              <div id="node15" class="node"></div>
              <div id="node16" class="node"></div>
              <div id="node17" class="node">
                <div id="node18" class="node"></div>
                <div id="node19" class="node"></div>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </div>

  <div id="debug"></div>

</body>

<script type="text/javascript">
  // utils
  jQuery.prototype.oldToString = jQuery.prototype.toString;
  jQuery.prototype.toString = function() {  // generate string keys for hashes
    if (this[0]) return this[0].id; else return this.oldToString();
  }
  function sqr(val)    { return val * val;                    }
  function debug(line) { $('#debug').append(line + '<br />'); }

  // now get to the business
  var jsGraph = window.jsGraph = function(id) {
    this.init(id);
    return this;
  }
  
  jsGraph.prototype = {
    init: function(id) {
      this.list  = {};
      this.edges = [];
      this.graph = $('#' + id);
      this.jg = new jsGraphics(id);
      this.traverse(this.graph, this.create_node);
      $(document).ready(function() {
        $("img").draggable({drag: function(event, ui) {
          this.redraw();
        }});  
      });
      this.force_direct();
      this.redraw();
    },
    
    create_node: function(val) {
      var img = $(document.createElement("img"));
      img.attr('id',       'i' + val.id)
         .attr('src',      val.id == 'node1' ? 'images/node-red.png' : 'images/node-green.png');
      img.css('position',  'absolute')
         .css('zIndex',    1);
      this.graph.append(img);
      this.list[$(val)] = {
        x: Math.random()*parseInt(this.graph.css('width')),
        y: Math.random()*parseInt(this.graph.css('height')),
        node:     img,
        halfsize: [6, 6],
        dx: 0,
        dy: 0,
        fixed: false,
        massfade: 0,
        justMadeLocal: false, 
        markedForRemoval: false,
        repulsion: 20.0
      };
/*      if (val.id == 'node1') {
        this.list[$(val)].x = parseInt(this.graph.css('width')) / 2;
        this.list[$(val)].y = parseInt(this.graph.css('height')) / 2;
      }*/
    },

    traverse: function(data, func) {
      var self = this;
      $(data).children('div.node').each(function() {
        func.call(self, this);
        if (this.childNodes)  self.traverse(this, func);
      });
    },
    
    draw_edges: function(val) {
      var node1 = this.list[$(val)];
      var node2 = this.list[$(val.parentNode)];
      if (node1 && node2) 
      {
        //debug(node1.node + ': ' + node1.position[0] + ', ' + node1.position[1] + ';  ' +
        //      node2.node + ': ' + node2.position[0] + ', ' + node2.position[1]);
        node1.node.css('left', node1.x).css('top', node1.y);
        node2.node.css('left', node2.x).css('top', node2.y);
        this.jg.drawLine(node1.x + node1.halfsize[0], node1.y + node1.halfsize[1], 
                         node2.x + node2.halfsize[0], node2.y + node2.halfsize[1]);
      }
    },
    
    redraw: function() {
      this.jg.setColor("#ddd");
      this.jg.clear();
      this.traverse(this.graph, this.draw_edges);
      this.jg.paint();
    },
    
    find_edges: function(val) {
      if ($(val).parent() == this.graph.id)  return;
      var node   = this.list[$(val)];
      var parent = this.list[$(val).parent()];
      if (node && parent) {
        this.edges.push({ from: node, to: parent });
      }
    },

    force_direct: function() {        
      var self = this;
      this.traverse(this.graph, this.find_edges);
      
      // Algorithm borrowed from TouchGraph by Alexander Shapiro
      var damper = 1.0, maxMotion = 0.0, lastMaxMotion = 0.0, motionRatio = 0.0, damping = true; 
      var rigidity = 1.0, newRigidity = 1.0;
      var dragNode = null;
      var defaultLength = 10.0;
      
      var relaxEdges = function() {
        $.each(self.edges, function() {
          var e = this;

          var vx = e.to.x - e.from.x;
          var vy = e.to.y - e.from.y;
          var len = Math.sqrt(vx * vx + vy * vy);

          var dx=vx*rigidity;
          var dy=vy*rigidity;

          dx /=(defaultLength*100);
          dy /=(defaultLength*100);

          if (e.to.justMadeLocal || e.to.markedForRemoval || 
              (!e.from.justMadeLocal && !e.from.markedForRemoval)) {
          	e.to.dx -= dx*len;
            e.to.dy -= dy*len;
          } else {
          	var massfade = (e.from.markedForRemoval ? e.from.massfade : 1-e.from.massfade);
          	massfade *= massfade;
            e.to.dx -= dx*len*massfade;
            e.to.dy -= dy*len*massfade;
          }
          if (e.from.justMadeLocal || e.from.markedForRemoval || 
              (!e.to.justMadeLocal && !e.to.markedForRemoval)) {                
            e.from.dx += dx*len;
            e.from.dy += dy*len;
          } else {
          	var massfade = (e.to.markedForRemoval ? e.to.massfade : 1-e.to.massfade);
          	massfade *= massfade;
            e.from.dx += dx*len*massfade;
            e.from.dy += dy*len*massfade;
          }
        });
      }
    
      var avoidLabels = function() {
        $.each(self.list, function() {
          var n1 = this;
          $.each(self.list, function() {
            var n2 = this;
            if (n1 == n2)  return;

            var dx=0;
            var dy=0;
            var vx = n1.x - n2.x;
            var vy = n1.y - n2.y;
            var len = vx * vx + vy * vy;

            if (len == 0) {
              dx = Math.random();
              dy = Math.random();
            } else if (len <600*600) { 
              dx = vx / len; 
              dy = vy / len; 
            }			

            var repSum = n1.repulsion * n2.repulsion/100;                              
            if(n1.justMadeLocal || n1.markedForRemoval || (!n2.justMadeLocal && !n2.markedForRemoval)) {  
              n1.dx += dx*repSum*rigidity;
              n1.dy += dy*repSum*rigidity;
            }
            else {
            	var massfade = (n2.markedForRemoval ? n2.massfade : 1-n2.massfade);
            	massfade*=massfade;
              n1.dx += dx*repSum*rigidity*massfade;
              n1.dy += dy*repSum*rigidity*massfade;
            }
            if (n2.justMadeLocal || n2.markedForRemoval || (!n1.justMadeLocal && !n1.markedForRemoval)) {
              n2.dx -= dx*repSum*rigidity;                  		
              n2.dy -= dy*repSum*rigidity;
            }
            else {
              var massfade = (n1.markedForRemoval ? n1.massfade : 1-n1.massfade);
            	massfade*=massfade;
              n2.dx -= dx*repSum*rigidity*massfade;
              n2.dy -= dy*repSum*rigidity*massfade;
            }               
          });
        });
      }
    
      var damp = function() {
        if (damping) {
          if(motionRatio <= 0.001) {
            if ((maxMotion < 0.2 || (maxMotion > 1 && damper < 0.9)) && damper > 0.01) damper -= 0.01;
            else if (maxMotion < 0.4 && damper > 0.003) damper -= 0.003;
            else if(damper > 0.0001) damper -= 0.0001;
          }
        }
        if(maxMotion<0.001 && damping) {
          damper=0;
        }
      }
    
      var moveNodes = function() {
        lastMaxMotion = maxMotion;
        var maxMotionA = 0;

        $.each(self.list, function() {
          var n = this;
        
          var dx = n.dx, dy = n.dy;

          dx *= damper;
          dy *= damper;
          n.dx= dx/2; 
          n.dy= dy/2; 

          var distMoved = Math.sqrt(dx*dx+dy*dy); 
          if (!n.fixed && !(n == dragNode)) {
            n.x += Math.max(-30, Math.min(30, dx)); 
            n.y += Math.max(-30, Math.min(30, dy)); 
          }
        
          maxMotionA = Math.max(distMoved, maxMotionA);
          if(!n.justMadeLocal && !n.markedForRemoval) { n.massfade=1; }
  				else { 					 
  					if(n.massfade>=0.004) n.massfade-=0.004; 
  				}
        });

        maxMotion=maxMotionA;
        if (maxMotion>0) motionRatio = lastMaxMotion/maxMotion-1; 
        else motionRatio = 0;                                     

        damp();
      }    

      do {
        for (var i = 0; i < 10; i++) {
          relaxEdges();
          avoidLabels();
          moveNodes();
        }
        rigidity= newRigidity;
        //self.redraw();
      }
      while(maxMotion > 0.01);
    }
  }

  var graph = new jsGraph('graph');
 
</script>
